"use strict";var CPayV3=(()=>{var w=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var M=(i,t)=>{for(var e in t)w(i,e,{get:t[e],enumerable:!0})},L=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of j(t))!H.call(i,n)&&n!==e&&w(i,n,{get:()=>t[n],enumerable:!(r=S(t,n))||r.enumerable});return i};var z=i=>L(w({},"__esModule",{value:!0}),i);var $={};M($,{create:()=>_});var y=class{getApiBaseUrl(){return"http://api.cryptumpay.local"}getJwtRefreshInterval(){return 30*1e3}},C=new y;var l=class{name;constructor(t){this.name=t}key(t){return`${this.name}:${t}`}};var h=class extends l{items={};set(t,e){this.items[t]=e}get(t){return this.items[t]||null}remove(t){delete this.items[t]}};var b=class{auth;constructor(){this.auth=new h("auth")}setAccessToken(t){this.auth.set("jwtAccessToken",t)}getAccessToken(){return this.auth.get("jwtAccessToken")}forgetSensitiveData(){this.auth.remove("jwtAccessToken")}},P=new b;var v=class{config;store;logged=!1;isInitialization=!1;initialized=!1;onReady;autoRefreshToken;constructor(t,e){this.config=t,this.store=e,this.onReady=[]}get isLogged(){return this.logged}get isReady(){return this.initialized}async ready(){if(this.initialized)return;let t=new Promise(e=>{this.onReady.push(e)});return this.isInitialization||(this.isInitialization=!0,this.init()),t}unload(){this.logged=!1,this.isInitialization=!1,this.initialized=!1,this.store.forgetSensitiveData()}async init(){await this.refreshToken(),this.initialized=!0,this.isInitialization=!1;for(let t of this.onReady)t()}async refreshToken(){let t=`${this.config.getApiBaseUrl()}/user/refresh-token`;return this.autoRefreshToken&&clearInterval(this.autoRefreshToken),new Promise(e=>{fetch(t,{method:"POST",credentials:"include"}).then(r=>{if(r.status===401)throw this.logged=!1,this.store.forgetSensitiveData(),new Error("Unauthorized");return r.json()}).then(r=>{if(!r.accessToken)throw new Error("Invalid response");this.logged=!0,this.store.setAccessToken(r.accessToken),this.autoRefreshToken=setInterval(()=>this.refreshToken(),this.config.getJwtRefreshInterval()),e()}).catch(r=>{r.message!=="Unauthorized"&&console.warn(r),e()})})}async logout(){let t=`${this.config.getApiBaseUrl()}/user/logout`;return new Promise(e=>{fetch(t,{method:"POST",credentials:"include"}).then(r=>r.json()).then(r=>{this.logged=!1,this.store.forgetSensitiveData(),e(!0)}).catch(r=>{console.warn(r),e(!1)})})}},o=new v(C,P);var T="#widget{width:300px;margin:20px;border:1px solid #aeaeae;border-radius:6px;display:flex;align-items:center;box-sizing:border-box;align-items:stretch}#widget_pay{flex-grow:1;display:flex;align-items:center;justify-content:center;font-size:15px;font-family:Verdana,Geneva,Tahoma,sans-serif;background:#61c3ff;color:#fff;cursor:pointer}#widget_pay.wide{padding:15px 0}#widget_pay:hover{background:#38b3ff}#widget_settings{display:flex;flex-direction:column;text-align:center;max-width:50%;background:#ade0ff;color:#6f6f6f;text-align:right}#widget_wallet{cursor:pointer;text-align:right}#widget_wallet:hover{background:#98d7ff}#widget_settings>div{padding:3px 20px}";var k=()=>T;var E=class{injectedTags=[];injectElement(t,e){t.appendChild(e),this.injectedTags.push(e)}injectStyles(){let t=document.createElement("style");t.textContent=k(),this.injectElement(document.head,t)}findElement(t){let e=document.getElementById(t);if(e)return e;throw new Error(`Unknown element ${t}.`)}unload(){for(let t of this.injectedTags.reverse())t&&t.remove();this.injectedTags=[]}},d=new E;var A=({id:i,network:t,ticker:e,chain:r,contract:n})=>{let a=[i,t,e,r,n];if(!a.every(x=>x.length>0))throw new Error("Malformed currency");let c=a.join(":");return Buffer.from(c).toString("hex").substring(0,39-c.length)},R=i=>{if(!i||typeof i!="string")throw new Error("Invalid currency");let t=i.split(":");if(t.length!==6||i.length!==40)throw new Error("Wrong format of the currency");let[e,r,n,a,c,I]=t;if(A({id:e,network:r,ticker:n,chain:a,contract:c})!==I)throw new Error("Wrong currency hash")};var m=class{#t;#e;#i;#r;#n;#s;#o;#a;constructor(t){this.#t=t}setOrderId(t){this.#e!==t&&(this.#e=t,this.#t())}setCustomerId(t){this.#i!==t&&(this.#i=t,this.#t())}setMerchantId(t){this.#r!==t&&(this.#r=t,this.#t())}setPrice(t,e,r){this.#n===t&&this.#o===e&&this.#s===r||(R(e),this.#n=t,this.#o=e,this.#s=r,this.#t())}setDescription(t){this.#a!==t&&(this.#a=t,this.#t())}getSettings(){return{orderId:this.#e,customerId:this.#i,merchantId:this.#r,amount:this.#n,canEditAmount:this.#s,currency:this.#o,description:this.#a}}};var s=class{container;rootItems=[];parent;childs=[];constructor(t){this.container=t}async init(){return this}unload(){}cascadeUnload(){this.childs.forEach(t=>t.cascadeUnload()),this.childs=[],this.unload(),this.parent=void 0,this.container=void 0,this.rootItems=[]}setParent(t){this.parent=t}setContainer(t){this.container=t}registerRootItems(t){this.rootItems=t}getParent(){return this.parent}getContainer(){return this.container}getRootItems(){return this.rootItems}addChild(t,e){if(e=e||this.container,!e)throw new Error("Container was not set");let r=t.getRootItems();if(!r.length)throw new Error("Root items was not set");this.childs.push(t),t.setParent(this);for(let n of r)d.injectElement(e,n)}};var g=class extends s{async init(){let t=document.createElement("div");return t.id="widget_pay",t.className="wide",t.textContent="Pay with CryptumPay",this.registerRootItem(t),this}};var p=class extends s{async init(){let t=document.createElement("div");t.id="widget_pay",t.textContent="Pay";let e=document.createElement("div");e.id="widget_settings";let r=document.createElement("div");r.id="widget_price",r.textContent="100500 USDT";let n=document.createElement("div");n.id="widget_wallet";let a=document.createElement("span");a.textContent="3TN\u20269FA";let c=document.createElement("span");return c.innerHTML="&#9662;",n.appendChild(a),n.appendChild(c),e.appendChild(r),e.appendChild(n),this.registerRootItems([t,e]),this}};var u=class extends s{config;constructor(){super(),this.config=new m(()=>this.update())}getConfig(){return this.config}async init(){await o.ready();let t=document.createElement("div");return t.id="widget",o.isLogged?this.addChild(await new g(t).init(),t):this.addChild(await new p(t).init(),t),this.registerRootItems([t]),this}update(){o.isReady}};var f=class i extends s{static RegisteredIds=new Set;id;constructor(t){if(i.RegisteredIds.has(t))throw new Error(`Id ${t} is already in use`);super(d.findElement(t)),i.RegisteredIds.add(t),this.id=t}async init(){return await o.ready(),this}unload(){i.RegisteredIds.delete(this.id)}};var _=async i=>{let t=new f(i),e=new u;return d.injectStyles(),await Promise.all([t.init(),e.init()]),t.addChild(e),{remove:()=>{t.cascadeUnload(),d.unload(),o.unload()},config:e.getConfig()}};return z($);})();
