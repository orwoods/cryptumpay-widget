"use strict";var CPayV3=(()=>{var x=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var H=(r,t)=>{for(var e in t)x(r,e,{get:t[e],enumerable:!0})},j=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!M.call(r,n)&&n!==e&&x(r,n,{get:()=>t[n],enumerable:!(i=z(t,n))||i.enumerable});return r};var B=r=>j(x({},"__esModule",{value:!0}),r);var W={};H(W,{create:()=>$});var T=class{getApiBaseUrl(){return"http://api.cryptumpay.local"}getJwtRefreshInterval(){return 30*1e3}},p=new T;var u=class{name;constructor(t){this.name=t}key(t){return`${this.name}:${t}`}};var g=class extends u{items={};set(t,e){this.items[t]=e}get(t){return this.items[t]||null}remove(t){delete this.items[t]}};var P=class{auth;constructor(){this.auth=new g("auth")}setAccessToken(t){this.auth.set("jwtAccessToken",t)}getAccessToken(){return this.auth.get("jwtAccessToken")}forgetSensitiveData(){this.auth.remove("jwtAccessToken")}},f=new P;var k=class{config;store;logged=!1;isInitialization=!1;initialized=!1;onReady;autoRefreshToken;constructor(t,e){this.config=t,this.store=e,this.onReady=[]}get isLogged(){return this.logged}get isReady(){return this.initialized}async ready(){if(this.initialized)return;let t=new Promise(e=>{this.onReady.push(e)});return this.isInitialization||(this.isInitialization=!0,this.init()),t}unload(){this.logged=!1,this.isInitialization=!1,this.initialized=!1,this.store.forgetSensitiveData()}async init(){await this.refreshToken(),this.initialized=!0,this.isInitialization=!1;for(let t of this.onReady)t()}async refreshToken(){let t=`${this.config.getApiBaseUrl()}/auth/refresh-token`;return this.autoRefreshToken&&clearInterval(this.autoRefreshToken),new Promise(e=>{fetch(t,{method:"POST",credentials:"include"}).then(i=>{if(i.status===401)throw this.logged=!1,this.store.forgetSensitiveData(),new Error("Unauthorized");return i.json()}).then(i=>{if(!i.accessToken)throw new Error("Invalid response");this.logged=!0,this.store.setAccessToken(i.accessToken),this.autoRefreshToken=setInterval(()=>this.refreshToken(),this.config.getJwtRefreshInterval()),e()}).catch(i=>{i.message!=="Unauthorized"&&console.warn(i),e()})})}async logout(){let t=`${this.config.getApiBaseUrl()}/auth/logout`;return new Promise(e=>{fetch(t,{method:"POST",credentials:"include"}).then(i=>i.json()).then(i=>{this.logged=!1,this.store.forgetSensitiveData(),e(!0)}).catch(i=>{console.warn(i),e(!1)})})}},c=new k(p,f);var O="#widget{width:300px;margin:20px;border:1px solid #aeaeae;border-radius:6px;display:flex;align-items:center;box-sizing:border-box;align-items:stretch}#widget_pay{flex-grow:1;display:flex;align-items:center;justify-content:center;font-size:15px;font-family:Verdana,Geneva,Tahoma,sans-serif;background:#61c3ff;color:#fff;cursor:pointer}#widget_pay.wide{padding:15px 0}#widget_pay:hover{background:#38b3ff}#widget_settings{display:flex;flex-direction:column;text-align:center;max-width:50%;background:#ade0ff;color:#6f6f6f;text-align:right}#widget_wallet{cursor:pointer;text-align:right}#widget_wallet:hover{background:#98d7ff}#widget_settings>div{padding:3px 20px}";var L=()=>O;var R=class{styles;injectElement(t,e){t.appendChild(e)}injectStyles(){let t=document.createElement("style");t.textContent=L(),this.injectElement(document.head,t),this.styles=t}findElement(t){let e=document.getElementById(t);if(e)return e;throw new Error(`Unknown element ${t}.`)}unload(){this.styles&&this.styles.remove()}},h=new R;var _=({id:r,network:t,ticker:e,chain:i,contract:n})=>{let l=[r,t,e,i,n];if(!l.every(o=>o.length>0))throw new Error("Malformed currency");let s=l.join(":");return Buffer.from(s).toString("hex").substring(0,39-s.length)},U=r=>{if(!r||typeof r!="string")throw new Error("Invalid currency");let t=r.split(":");if(t.length!==6||r.length!==40)throw new Error("Wrong format of the currency");let[e,i,n,l,s,a]=t;if(_({id:e,network:i,ticker:n,chain:l,contract:s})!==a)throw new Error("Wrong currency hash")};var w=class{#t;#e;#i;#r;#n;#o;#s;#a;#c;constructor(t){this.#t=t}setOrderId(t){this.#e!==t&&(this.#e=t,this.#t())}setCustomerId(t){this.#i!==t&&(this.#i=t,this.#t())}setMerchantId(t){this.#r!==t&&(this.#r=t,this.#t())}setClientOrderId(t){this.#n!==t&&(this.#n=t,this.#t())}setPrice(t,e,i){this.#o===t&&this.#a===e&&this.#s===i||(U(e),this.#o=t,this.#a=e,this.#s=i,this.#t())}setDescription(t){this.#c!==t&&(this.#c=t,this.#t())}getSettings(){return{orderId:this.#e,customerId:this.#i,merchantId:this.#r,clientOrderId:this.#n,amount:this.#o,canEditAmount:this.#s,currency:this.#a,description:this.#c}}};var d=class r{static maxId=0;id=++r.maxId;container;rootItems=[];parent;childs=new Map;constructor(t){this.container=t}async init(){}unload(){}cascadeUnload(){this.childs.forEach(t=>this.removeChild(t)),this.unload(),this.parent=void 0,this.container=void 0,this.rootItems=[]}setParent(t){this.parent=t}setContainer(t){this.container=t}registerRootItems(t){this.rootItems=t}getParent(){return this.parent}getContainer(){return this.container}getRootItems(){return this.rootItems}addChild(t,e){if(e=e||this.container,!e)throw new Error("Container was not set");let i=t.getRootItems();if(!i.length)throw new Error("Root items was not set");this.childs.set(t.id,t),t.setParent(this),t.setContainer(e);for(let n of i)h.injectElement(e,n)}beforeRemoveChild(t){}removeChild(t){let e=t.getRootItems();if(!e.length)throw new Error("Root items was not set");this.beforeRemoveChild(t),t.cascadeUnload(),t.setParent(),t.setContainer();for(let i of e)i.remove();this.childs.delete(t.id)}remove(){let t=this.getParent();t&&t.removeChild(this)}};var S=class{config;store;constructor(t,e){this.config=t,this.store=e}async request({endpoint:t,method:e="GET",data:i={},withCredentials:n=!1,withAuthorization:l=!0}){let s=new URL(`${this.config.getApiBaseUrl()}${t}`),a={method:e,headers:{"Content-Type":"application/json"}};e==="GET"?Object.keys(i).forEach(o=>s.searchParams.append(o,i[o])):a.body=JSON.stringify(i),n&&(a.credentials="include"),l&&(a.headers={...a.headers,Authorization:`Bearer ${this.store.getAccessToken()}`});try{let o=await fetch(s,a);if(o.status===401)throw new Error("Unauthorized request");if(o.status!==200)throw new Error("Response code is not 200");return await o.json()}catch(o){throw console.warn(o),new Error("Unexpected error")}}async createOrder(t){return await this.request({endpoint:"/order",method:"POST",data:t,withAuthorization:!0,withCredentials:!0})}async getUser(){return await this.request({endpoint:"/user",withAuthorization:!0})}},y=new S(p,f);var b=class extends d{async init(){let t=document.createElement("div");t.id="order_popup",this.registerRootItems([t])}};var m=class extends d{button;clicked=!1;locked=!1;config;constructor(t){super(),this.config=t}async click(){if(!(this.clicked||this.locked)){this.clicked=!0;try{await this.createOrder()}catch(t){console.warn("ButtonCommon error",t)}this.clicked=!1}}async createOrder(){try{let t=this.config.getSettings(),e=await y.createOrder({currency:t.currency||"",amount:t.amount||0,description:t.description||"",merchantId:t.merchantId||"",customerId:t.customerId||"",clientOrderId:t.clientOrderId||""});console.warn("order result:"),console.warn(e);let i=e.orderId;this.locked=!0,await c.refreshToken(),this.addChild(await this.openOrderPopup(i),this.getContainer())}catch{let t=this.button.textContent;this.button.textContent="\u{1F61E}",setTimeout(()=>{this.button.textContent=t,this.locked=!1},3e3)}}async openOrderPopup(t){let e=new b;return await e.init(),e}beforeRemoveChild(t){this.locked=!1}};var v=class extends m{async init(){let t=document.createElement("div");t.id="widget_pay",t.className="wide",t.textContent="Pay with CryptumPay",this.button=t,t.addEventListener("click",this.click.bind(this)),this.registerRootItems([t])}};var I=class extends m{async init(){let t=document.createElement("div");t.id="widget_pay",t.textContent="Pay";let e=document.createElement("div");e.id="widget_settings";let i=document.createElement("div");i.id="widget_price",i.textContent="100500 USDT";let n=document.createElement("div");n.id="widget_wallet";let l=document.createElement("span");l.textContent="3TN\u20269FA";let s=document.createElement("span");s.innerHTML="&#9662;",n.appendChild(l),n.appendChild(s),e.appendChild(i),e.appendChild(n),n.addEventListener("click",async()=>{let a=await y.getUser();console.warn(a)}),this.registerRootItems([t,e])}};var C=class extends d{config;constructor(){super(),this.config=new w(()=>this.update())}getConfig(){return this.config}async init(){await c.ready();let t=document.createElement("div");t.id="widget",c.isLogged?this.addChild(await this.createLoggedButton(),t):this.addChild(await this.createAnonymousButton(),t),this.registerRootItems([t])}async createLoggedButton(){let t=new I(this.config);return await t.init(),t}async createAnonymousButton(){let t=new v(this.config);return await t.init(),t}update(){c.isReady}};var E=class r extends d{static RegisteredIds=new Set;rootId;constructor(t){if(r.RegisteredIds.has(t))throw new Error(`Id ${t} is already in use`);super(h.findElement(t)),r.RegisteredIds.add(t),this.rootId=t}async init(){await c.ready()}unload(){r.RegisteredIds.delete(this.rootId)}};var $=async r=>{let t=new E(r),e=new C;return h.injectStyles(),await Promise.all([t.init(),e.init()]),t.addChild(e),{remove:()=>{t.cascadeUnload(),h.unload(),c.unload()},config:e.getConfig()}};return B(W);})();
