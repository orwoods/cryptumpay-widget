"use strict";var CPayV3=(()=>{var m=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var j=(i,t)=>{for(var e in t)m(i,e,{get:t[e],enumerable:!0})},H=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of R(t))!S.call(i,n)&&n!==e&&m(i,n,{get:()=>t[n],enumerable:!(r=P(t,n))||r.enumerable});return i};var M=i=>H(m({},"__esModule",{value:!0}),i);var A={};j(A,{create:()=>U});var f=class{getApiBaseUrl(){return"http://api.cryptumpay.local"}getJwtRefreshInterval(){return 30*1e3}},x=new f;var d=class{name;constructor(t){this.name=t}key(t){return`${this.name}:${t}`}};var h=class extends d{items={};set(t,e){this.items[t]=e}get(t){return this.items[t]||null}remove(t){delete this.items[t]}};var w=class{auth;constructor(){this.auth=new h("auth")}setAccessToken(t){this.auth.set("jwtAccessToken",t)}getAccessToken(){return this.auth.get("jwtAccessToken")}forgetSensitiveData(){this.auth.remove("jwtAccessToken")}},E=new w;var y=class{config;store;logged=!1;isInitialization=!1;initialized=!1;onReady;autoRefreshToken;constructor(t,e){this.config=t,this.store=e,this.onReady=[]}get isLogged(){return this.logged}get isReady(){return this.initialized}async ready(){if(this.initialized)return;let t=new Promise(e=>{this.onReady.push(e)});return this.isInitialization||(this.isInitialization=!0,this.init()),t}unload(){this.logged=!1,this.isInitialization=!1,this.initialized=!1,this.store.forgetSensitiveData()}async init(){await this.refreshToken(),this.initialized=!0,this.isInitialization=!1;for(let t of this.onReady)t()}async refreshToken(){let t=`${this.config.getApiBaseUrl()}/user/refresh-token`;return this.autoRefreshToken&&clearInterval(this.autoRefreshToken),new Promise(e=>{fetch(t,{method:"POST",credentials:"include"}).then(r=>{if(r.status===401)throw this.logged=!1,this.store.forgetSensitiveData(),new Error("Unauthorized");return r.json()}).then(r=>{if(!r.accessToken)throw new Error("Invalid response");this.logged=!0,this.store.setAccessToken(r.accessToken),this.autoRefreshToken=setInterval(()=>this.refreshToken(),this.config.getJwtRefreshInterval()),e()}).catch(r=>{r.message!=="Unauthorized"&&console.warn(r),e()})})}async logout(){let t=`${this.config.getApiBaseUrl()}/user/logout`;return new Promise(e=>{fetch(t,{method:"POST",credentials:"include"}).then(r=>r.json()).then(r=>{this.logged=!1,this.store.forgetSensitiveData(),e(!0)}).catch(r=>{console.warn(r),e(!1)})})}},o=new y(x,E);var T="#widget{width:300px;margin:20px;border:1px solid #aeaeae;border-radius:6px;display:flex;align-items:center;box-sizing:border-box;align-items:stretch}#widget_pay{flex-grow:1;display:flex;align-items:center;justify-content:center;font-size:15px;font-family:Verdana,Geneva,Tahoma,sans-serif;background:#61c3ff;color:#fff;cursor:pointer}#widget_pay.wide{padding:15px 0}#widget_pay:hover{background:#38b3ff}#widget_settings{display:flex;flex-direction:column;text-align:center;max-width:50%;background:#ade0ff;color:#6f6f6f;text-align:right}#widget_wallet{cursor:pointer;text-align:right}#widget_wallet:hover{background:#98d7ff}#widget_settings>div{padding:3px 20px}";var k=()=>T;var b=class{injectedTags=[];injectElement(t,e){t.appendChild(e),this.injectedTags.push(e)}injectStyles(){let t=document.createElement("style");t.textContent=k(),this.injectElement(document.head,t)}findElement(t){let e=document.getElementById(t);if(e)return e;throw new Error(`Unknown element ${t}.`)}unload(){for(let t of this.injectedTags.reverse())t&&t.remove();this.injectedTags=[]}},s=new b;var L=({id:i,network:t,ticker:e,chain:r,contract:n})=>{let c=[i,t,e,r,n];if(!c.every(I=>I.length>0))throw new Error("Malformed currency");let l=c.join(":");return Buffer.from(l).toString("hex").substring(0,39-l.length)},C=i=>{if(!i||typeof i!="string")throw new Error("Invalid currency");let t=i.split(":");if(t.length!==6||i.length!==40)throw new Error("Wrong format of the currency");let[e,r,n,c,l,v]=t;if(L({id:e,network:r,ticker:n,chain:c,contract:l})!==v)throw new Error("Wrong currency hash")};var g=class{#t;#e;#i;#r;#n;#s;#o;#a;constructor(t){this.#t=t}setOrderId(t){this.#e!==t&&(this.#e=t,this.#t())}setCustomerId(t){this.#i!==t&&(this.#i=t,this.#t())}setMerchantId(t){this.#r!==t&&(this.#r=t,this.#t())}setPrice(t,e,r){this.#n===t&&this.#o===e&&this.#s===r||(C(e),this.#n=t,this.#o=e,this.#s=r,this.#t())}setDescription(t){this.#a!==t&&(this.#a=t,this.#t())}getSettings(){return{orderId:this.#e,customerId:this.#i,merchantId:this.#r,amount:this.#n,canEditAmount:this.#s,currency:this.#o,description:this.#a}}};var a=class{container;rootItem;parent;childs=[];constructor(t){this.container=t}async init(){}unload(){}cascadeUnload(){this.childs.forEach(t=>t.cascadeUnload()),this.childs=[],this.unload(),this.parent=void 0,this.container=void 0,this.rootItem=void 0}setParent(t){this.parent=t}setContainer(t){this.container=t}registerRootItem(t){this.rootItem=t}getParent(){return this.parent}getContainer(){return this.container}getRootItem(){return this.rootItem}addChild(t,e){if(e=e||this.container,!e)throw new Error("Container was not set");let r=t.getRootItem();if(!r)throw new Error("Root item was not set");this.childs.push(t),t.setParent(this),s.injectElement(e,r)}};var u=class extends a{config;constructor(){super(),this.config=new g(()=>this.update())}async init(){await this.create()}getConfig(){return this.config}async create(){let t=document.createElement("div");t.id="widget";let e=document.createElement("div");e.id="widget_pay",e.className="wide",e.textContent="Pay with CryptumPay",t.appendChild(e),this.registerRootItem(t)}update(){o.isReady}};var p=class i extends a{static RegisteredIds=new Set;id;constructor(t){if(i.RegisteredIds.has(t))throw new Error(`Id ${t} is already in use`);super(s.findElement(t)),i.RegisteredIds.add(t),this.id=t}async init(){await o.ready()}unload(){i.RegisteredIds.delete(this.id)}};var U=async i=>{let t=new p(i),e=new u;return s.injectStyles(),await Promise.all([t.init(),e.init()]),t.addChild(e),{remove:()=>{t.cascadeUnload(),s.unload(),o.unload()},config:e.getConfig()}};return M(A);})();
